!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-scale"),require("vega-util"),require("d3-format"),require("vega-dataflow"),require("d3-array"),require("d3-interpolate")):"function"==typeof define&&define.amd?define(["exports","vega-scale","vega-util","d3-format","vega-dataflow","d3-array","d3-interpolate"],n):n((e.vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.d3,e.vega,e.d3,e.d3)}(this,function(e,v,M,u,g,y,i){"use strict";var x="log",k="pow",S="sqrt",o="band",l="point",s="linear",b="ordinal",f="quantile",c="quantize",O="threshold",d="bin-ordinal",m="sequential";function A(e,n){var t;return M.isObject(n)&&(t=n.step,n=n.interval),M.isString(n)&&(n="time"===e.type?v.timeInterval(n):"utc"===e.type?v.utcInterval(n):M.error("Only time and utc scales accept interval strings."),t&&(n=n.every(t))),n}function p(n,e,t){var r=n.range(),a=r[0],i=M.peek(r);if(i<a&&(r=i,i=a,a=r),e=e.filter(function(e){return!((e=n(e))<a||i<e)}),0<t&&1<e.length){for(var o=[e[0],M.peek(e)];e.length>t&&3<=e.length;)e=e.filter(function(e,n){return!(n%2)});e.length<3&&(e=o)}return e}function D(e,n){return e.ticks?e.ticks(n):e.domain()}function w(e,n,t){var r,a,i=e.tickFormat?e.tickFormat(n,t):t?u.format(t):String;return e.type===x?(r=i,a=function(e){var n=u.formatSpecifier(e||",");{if(null==n.precision){switch(n.precision=12,n.type){case"%":n.precision-=2;break;case"e":n.precision-=1}return i=u.format(n),o=u.format(".1f")(1)[1],function(e){var n,t,r=i(e),a=r.indexOf(o);if(a<0)return r;for(n=function(e,n){var t,r=e.lastIndexOf("e");if(0<r)return r;for(r=e.length;--r>n;)if(48<=(t=e.charCodeAt(r))&&t<=57)return r+1}(r,a),t=n<r.length?r.slice(n):"";--n>a;)if("0"!==r[n]){++n;break}return r.slice(0,n)+t}}return u.format(n)}var i,o}(t),function(e){return r(e)?a(e):""}):i}function n(e){g.Transform.call(this,null,e)}function t(e){g.Transform.call(this,null,e)}function h(){return g.ingest({})}function T(e){return e.exit}function r(e){g.Transform.call(this,null,e)}M.inherits(n,g.Transform).transform=function(e,n){if(this.value&&!e.modified())return n.StopPropagation;var t=n.fork(n.NO_SOURCE|n.NO_FIELDS),r=this.value,a=e.scale,i=null==e.count?e.values?e.values.length:10:A(a,e.count),o=e.format||w(a,i,e.formatSpecifier),u=e.values?p(a,e.values,i):D(a,i);return r&&(t.rem=r),r=u.map(function(e,n){return g.ingest({index:n/(u.length-1),value:e,label:o(e)})}),e.extra&&r.push(g.ingest({index:-1,extra:{value:r[0].value},label:""})),t.source=r,t.add=r,this.value=r,t},M.inherits(t,g.Transform).transform=function(e,n){var t=n.dataflow,r=n.fork(n.NO_SOURCE|n.NO_FIELDS),a=e.item||h,i=e.key||g.tupleid,o=this.value;return M.isArray(r.encode)&&(r.encode=null),o&&(e.modified("key")||n.modified(i))&&M.error("DataJoin does not support modified key function or fields."),o||(n=n.addAll(),this.value=o=M.fastmap().test(T),o.lookup=function(e){return o.get(i(e))}),n.visit(n.ADD,function(e){var n=i(e),t=o.get(n);t?t.exit?(o.empty--,r.add.push(t)):r.mod.push(t):(o.set(n,t=a(e)),r.add.push(t)),t.datum=e,t.exit=!1}),n.visit(n.MOD,function(e){var n=i(e),t=o.get(n);t&&(t.datum=e,r.mod.push(t))}),n.visit(n.REM,function(e){var n=i(e),t=o.get(n);e!==t.datum||t.exit||(r.rem.push(t),t.exit=!0,++o.empty)}),n.changed(n.ADD_MOD)&&r.modifies("datum"),e.clean&&o.empty>t.cleanThreshold&&t.runAfter(o.clean),r},M.inherits(r,g.Transform).transform=function(t,e){var r=e.fork(e.ADD_REM),n=t.encoders,a=e.encode;if(M.isArray(a)){if(!r.changed()&&!a.every(function(e){return n[e]}))return e.StopPropagation;a=a[0],r.encode=null}var i="enter"===a,o=n.update||M.falsy,u=n.enter||M.falsy,l=n.exit||M.falsy,s=(a&&!i?n[a]:o)||M.falsy;if(e.changed(e.ADD)&&(e.visit(e.ADD,function(e){u(e,t),o(e,t),s!==M.falsy&&s!==o&&s(e,t)}),r.modifies(u.output),r.modifies(o.output),s!==M.falsy&&s!==o&&r.modifies(s.output)),e.changed(e.REM)&&l!==M.falsy&&(e.visit(e.REM,function(e){l(e,t)}),r.modifies(l.output)),i||s!==M.falsy){var f=e.MOD|(t.modified()?e.REFLOW:0);i?(e.visit(f,function(e){var n=u(e,t);(s(e,t)||n)&&r.mod.push(e)}),r.mod.length&&r.modifies(u.output)):e.visit(f,function(e){s(e,t)&&r.mod.push(e)}),r.mod.length&&r.modifies(s.output)}return r.changed()?r:e.StopPropagation};var z="symbol",E="discrete",F={};function R(e,n,t){return t===z&&F[e.type]?(o=n,function(e,n,t){var r=t[n+1]||t.max||1/0,a=C(e,o),i=C(r,o);return a&&i?a+"–"+i:i?"< "+i:"≥ "+a}):t===E?(a=n,function(e,n){return n?a(e):null}):(r=n,function(e){return r(e)});var r,a,o}function C(e,n){return isFinite(e)?n(e):null}function a(e){g.Transform.call(this,[],e)}F[f]=function(e){var n=[-1/0].concat(e.quantiles());return n.max=1/0,n},F[c]=function(e){var n=e.domain(),t=n[0],r=M.peek(n),a=e.range().length,i=new Array(a),o=0;i[0]=-1/0;for(;++o<a;)i[o]=(o*r-(o-a)*t)/a;return i.max=1/0,i},F[O]=function(e){var n=[-1/0].concat(e.domain());return n.max=1/0,n},F["bin-linear"]=F[d]=function(e){var n=e.domain();return n.max=n.pop(),n},M.inherits(a,g.Transform).transform=function(t,e){if(null!=this.value&&!t.modified())return e.StopPropagation;var n,r,a,i,o,u,l,s=e.fork(e.NO_SOURCE|e.NO_FIELDS),f=this.value,c=t.type||z,d=t.scale,m=null==t.count?5:A(d,t.count),p=t.format||w(d,m,t.formatSpecifier),h=t.values||(u=m,(l=F[(o=d).type])?l(o):D(o,u));return p=R(d,p,c),f&&(s.rem=f),c===z?(M.isFunction(a=t.size)?(t.values||0!==d(h[0])||(h=h.slice(1)),i=h.reduce(function(e,n){return Math.max(e,a(n,t))},0)):a=M.constant(i=a||8),f=h.map(function(e,n){return g.ingest({index:n,label:p(e,n,h),value:e,offset:i,size:a(e,t)})})):"gradient"===c?(n=t.values?d.domain():h,r=v.scaleFraction(d,n[0],M.peek(n)),f=h.map(function(e,n){return g.ingest({index:n,label:p(e,n,h),value:e,perc:r(e)})})):(a=h.length-1,r=function(e){var n=e.domain(),t=n.length-1,r=+n[0],a=+M.peek(n),i=a-r;if(e.type===O){var o=t?i/t:.1;i=(a+=o)-(r-=o)}return function(e){return(e-r)/i}}(d),f=h.map(function(e,n){return g.ingest({index:n,label:p(e,n,h),value:e,perc:n?r(e):0,perc2:n===a?1:r(h[n+1])})})),s.source=f,s.add=f,this.value=f,s};var L=M.fastmap({line:U,"line-radial":function(e,n,t,r){return U(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},arc:j,"arc-radial":function(e,n,t,r){return j(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},curve:X,"curve-radial":function(e,n,t,r){return X(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},"orthogonal-horizontal":function(e,n,t,r){return"M"+e+","+n+"V"+r+"H"+t},"orthogonal-vertical":function(e,n,t,r){return"M"+e+","+n+"H"+t+"V"+r},"orthogonal-radial":function(e,n,t,r){var a=Math.cos(e),i=Math.sin(e),o=Math.cos(t),u=Math.sin(t),l=Math.abs(t-e)>Math.PI?t<=e:e<t;return"M"+n*a+","+n*i+"A"+n+","+n+" 0 0,"+(l?1:0)+" "+n*o+","+n*u+"L"+r*o+","+r*u},"diagonal-horizontal":function(e,n,t,r){var a=(e+t)/2;return"M"+e+","+n+"C"+a+","+n+" "+a+","+r+" "+t+","+r},"diagonal-vertical":function(e,n,t,r){var a=(n+r)/2;return"M"+e+","+n+"C"+e+","+a+" "+t+","+a+" "+t+","+r},"diagonal-radial":function(e,n,t,r){var a=Math.cos(e),i=Math.sin(e),o=Math.cos(t),u=Math.sin(t),l=(n+r)/2;return"M"+n*a+","+n*i+"C"+l*a+","+l*i+" "+l*o+","+l*u+" "+r*o+","+r*u}});function P(e){return e.source.x}function q(e){return e.source.y}function I(e){return e.target.x}function _(e){return e.target.y}function N(e){g.Transform.call(this,{},e)}function U(e,n,t,r){return"M"+e+","+n+"L"+t+","+r}function j(e,n,t,r){var a=t-e,i=r-n,o=Math.sqrt(a*a+i*i)/2;return"M"+e+","+n+"A"+o+","+o+" "+180*Math.atan2(i,a)/Math.PI+" 0 1 "+t+","+r}function X(e,n,t,r){var a=t-e,i=r-n,o=.2*(a+i),u=.2*(i-a);return"M"+e+","+n+"C"+(e+o)+","+(n+u)+" "+(t+u)+","+(r-o)+" "+t+","+r}function Y(e){g.Transform.call(this,null,e)}N.Definition={type:"LinkPath",metadata:{modifies:!0},params:[{name:"sourceX",type:"field",default:"source.x"},{name:"sourceY",type:"field",default:"source.y"},{name:"targetX",type:"field",default:"target.x"},{name:"targetY",type:"field",default:"target.y"},{name:"orient",type:"enum",default:"vertical",values:["horizontal","vertical","radial"]},{name:"shape",type:"enum",default:"line",values:["line","arc","curve","diagonal","orthogonal"]},{name:"as",type:"string",default:"path"}]},M.inherits(N,g.Transform).transform=function(e,n){var t=e.sourceX||P,r=e.sourceY||q,a=e.targetX||I,i=e.targetY||_,o=e.as||"path",u=e.orient||"vertical",l=e.shape||"line",s=L.get(l+"-"+u)||L.get(l);return s||M.error("LinkPath unsupported type: "+e.shape+(e.orient?"-"+e.orient:"")),n.visit(n.SOURCE,function(e){e[o]=s(t(e),r(e),a(e),i(e))}),n.reflow(e.modified()).modifies(o)},Y.Definition={type:"Pie",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"startAngle",type:"number",default:0},{name:"endAngle",type:"number",default:6.283185307179586},{name:"sort",type:"boolean",default:!1},{name:"as",type:"string",array:!0,length:2,default:["startAngle","endAngle"]}]},M.inherits(Y,g.Transform).transform=function(e,n){var t,r,a,i=e.as||["startAngle","endAngle"],o=i[0],u=i[1],l=e.field||M.one,s=e.startAngle||0,f=null!=e.endAngle?e.endAngle:2*Math.PI,c=n.source,d=c.map(l),m=d.length,p=s,h=(f-s)/y.sum(d),v=y.range(m);for(e.sort&&v.sort(function(e,n){return d[e]-d[n]}),t=0;t<m;++t)a=d[v[t]],(r=c[v[t]])[o]=p,r[u]=p+=a*h;return this.value=d,n.reflow(e.modified()).modifies(i)};var G=5,H=M.toSet([s,k,S]),V=M.toSet([s,x,k,S,"time","utc"]),B=M.toSet(["set","modified","clear","type","scheme","schemeExtent","schemeCount","domain","domainMin","domainMid","domainMax","domainRaw","nice","zero","range","rangeStep","round","reverse","interpolate","interpolateGamma"]);function J(e){g.Transform.call(this,null,e),this.modified(!0)}function W(e,n,t){return M.isFunction(e)&&(n||t)?v.interpolateRange(e,K(n||[0,1],t)):e}function K(e,n){return n?e.slice().reverse():e}function Q(e){g.Transform.call(this,null,e)}M.inherits(J,g.Transform).transform=function(e,n){var t,r=n.dataflow,a=this.value;for(t in a&&!e.modified("type")||(this.value=a=v.scale((e.type||s).toLowerCase())()),e)if(!B[t]){if("padding"===t&&V[a.type])continue;M.isFunction(a[t])?a[t](e[t]):r.warn("Unsupported scale property: "+t)}return function(e,n,t){var r=n.round||!1,a=n.range;if(null!=n.rangeStep)a=function(e,n,t){e!==o&&e!==l&&M.error("Only band and point scales support rangeStep.");var r=(null!=n.paddingOuter?n.paddingOuter:n.padding)||0,a=e===l?1:(null!=n.paddingInner?n.paddingInner:n.padding)||0;return[0,n.rangeStep*v.bandSpace(t,a,r)]}(e.type,n,t);else if(n.scheme){if(a=function(e,n,t){var r,a=n.scheme.toLowerCase(),i=v.scheme(a),o=n.schemeExtent;i||M.error("Unrecognized scheme name: "+n.scheme);return t=e===O?t+1:e===d?t-1:e===f||e===c?+n.schemeCount||G:t,e===m?W(i,o,n.reverse):!o&&(r=v.scheme(a+"-"+t))?r:M.isFunction(i)?function(e,n){for(var t=new Array(n),r=n+2,a=0;a<n;)t[a]=e(++a/r);return t}(W(i,o),t):e===b?i:i.slice(0,t)}(e.type,n,t),M.isFunction(a))return e.interpolator(a)}else if(a&&e.type===m)return e.interpolator(i.interpolateRgbBasis(K(a,n.reverse)));a&&n.interpolate&&e.interpolate?e.interpolate(v.interpolate(n.interpolate,n.interpolateGamma)):M.isFunction(e.round)?e.round(r):M.isFunction(e.rangeRound)&&e.interpolate(r?i.interpolateRound:i.interpolate);a&&e.range(K(a,n.reverse))}(a,e,function(e,n,t){var r=(a=e,i=n.domainRaw,i?(a.domain(i),i.length):-1);var a,i;if(-1<r)return r;var o,u,l=n.domain,s=e.type,f=n.zero||void 0===n.zero&&H[s];if(!l)return 0;V[s]&&n.padding&&l[0]!==M.peek(l)&&(c=s,d=l,m=n.range,p=n.padding,h=n.exponent,v=Math.abs(M.peek(m)-m[0]),g=v/(v-2*p),y=c===x?M.zoomLog(d,null,g):c===S?M.zoomPow(d,null,g,.5):c===k?M.zoomPow(d,null,g,h):M.zoomLinear(d,null,g),(d=d.slice())[0]=y[0],d[d.length-1]=y[1],l=d);var c,d,m,p,h,v,g,y;(f||null!=n.domainMin||null!=n.domainMax||null!=n.domainMid)&&(o=(l=l.slice()).length-1||1,f&&(0<l[0]&&(l[0]=0),l[o]<0&&(l[o]=0)),null!=n.domainMin&&(l[0]=n.domainMin),null!=n.domainMax&&(l[o]=n.domainMax),null!=n.domainMid&&(((u=n.domainMid)<l[0]||u>l[o])&&t.warn("Scale domainMid exceeds domain min or max.",u),l.splice(o,0,u)));e.domain(l),s===b&&e.unknown(void 0);n.nice&&e.nice&&e.nice(!0!==n.nice&&A(e,n.nice)||null);return l.length}(a,e,r)),n.fork(n.NO_SOURCE|n.NO_FIELDS)},M.inherits(Q,g.Transform).transform=function(e,n){var t=e.modified("sort")||n.changed(n.ADD)||n.modified(e.sort.fields)||n.modified("datum");return t&&n.source.sort(e.sort),this.modified(t),n};function Z(e){g.Transform.call(this,null,e)}function $(e,n,t,r,a){for(var i,o=(n-e.sum)/2,u=e.length,l=0;l<u;++l)(i=e[l])[r]=o,i[a]=o+=Math.abs(t(i))}function ee(e,n,t,r,a){for(var i,o=1/e.sum,u=0,l=e.length,s=0,f=0;s<l;++s)(i=e[s])[r]=u,i[a]=u=o*(f+=Math.abs(t(i)))}function ne(e,n,t,r,a){for(var i,o,u=0,l=0,s=e.length,f=0;f<s;++f)(i=t(o=e[f]))<0?(o[r]=l,o[a]=l+=i):(o[r]=u,o[a]=u+=i)}Z.Definition={type:"Stack",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"groupby",type:"field",array:!0},{name:"sort",type:"compare"},{name:"offset",type:"enum",default:"zero",values:["zero","center","normalize"]},{name:"as",type:"string",array:!0,length:2,default:["y0","y1"]}]},M.inherits(Z,g.Transform).transform=function(e,n){var t,r,a,i,o=e.as||["y0","y1"],u=o[0],l=o[1],s=e.field||M.one,f="center"===e.offset?$:"normalize"===e.offset?ee:ne;for(r=0,a=(t=function(e,n,t,r){var a,i,o,u,l,s,f,c,d,m=[],p=function(e){return e(l)};if(null==n)m.push(e.slice());else for(a={},i=0,o=e.length;i<o;++i)l=e[i],s=n.map(p),(f=a[s])||(a[s]=f=[],m.push(f)),f.push(l);for(d=s=0,u=m.length;s<u;++s){for(f=m[s],c=i=0,o=f.length;i<o;++i)c+=Math.abs(r(f[i]));f.sum=c,d<c&&(d=c),t&&f.sort(t)}return m.max=d,m}(n.source,e.groupby,e.sort,s)).length,i=t.max;r<a;++r)f(t[r],i,s,u,l);return n.reflow(e.modified()).modifies(o)},e.axisticks=n,e.datajoin=t,e.encode=r,e.legendentries=a,e.linkpath=N,e.pie=Y,e.scale=J,e.sortitems=Q,e.stack=Z,e.validTicks=p,Object.defineProperty(e,"__esModule",{value:!0})});