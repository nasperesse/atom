!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-util"),require("vega-loader")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-loader"],n):n(t.vega={},t.vega,t.vega)}(this,function(t,g,r){"use strict";function l(t){var r=t||g.identity,i=[],s={};return i.add=function(t){var n=r(t);return s[n]||(s[n]=1,i.push(t)),i},i.remove=function(t){var n,e=r(t);return s[e]&&(s[e]=0)<=(n=i.indexOf(t))&&i.splice(n,1),i},i}var e=Symbol("vega_id"),i=1;function m(t){return t[e]}function s(t,n){return t[e]=n,t}function _(t){var n=t===Object(t)?t:{data:t};return m(n)?n:s(n,i++)}function n(t,n){for(var e in t)n[e]=t[e];return n}function h(t){return t&&t.constructor===u}function u(){var h=[],c=[],f=[],d=[],p=[],v=!1;return{constructor:u,insert:function(t){for(var n=g.array(t),e=0,r=n.length;e<r;++e)h.push(n[e]);return this},remove:function(t){for(var n=g.isFunction(t)?d:c,e=g.array(t),r=0,i=e.length;r<i;++r)n.push(e[r]);return this},modify:function(t,n,e){var r={field:n,value:g.constant(e)};return g.isFunction(t)?(r.filter=t,p.push(r)):(r.tuple=t,f.push(r)),this},encode:function(t,n){return g.isFunction(t)?p.push({filter:t,field:n}):f.push({tuple:t,field:n}),this},reflow:function(){return v=!0,this},pulse:function(r,t){var i,n,e,s,u,o,a;for(n=0,e=h.length;n<e;++n)r.add.push(_(h[n]));for(i={},n=0,e=c.length;n<e;++n)i[m(o=c[n])]=o;for(n=0,e=d.length;n<e;++n)u=d[n],t.forEach(function(t){u(t)&&(i[m(t)]=t)});for(a in i)r.rem.push(i[a]);function l(t,n,e){e?t[n]=e(t):r.encode=n,v||(i[m(t)]=t)}for(i={},n=0,e=f.length;n<e;++n)l((s=f[n]).tuple,s.field,s.value),r.modifies(s.field);for(n=0,e=p.length;n<e;++n)s=p[n],u=s.filter,t.forEach(function(t){u(t)&&l(t,s.field,s.value)}),r.modifies(s.field);if(v)r.mod=c.length||d.length?t.filter(function(t){return i.hasOwnProperty(m(t))}):t.slice();else for(a in i)r.mod.push(i[a]);return r}}}var o="_:mod:_";function c(){Object.defineProperty(this,o,{writable:!0,value:{}})}var a=c.prototype;a.set=function(t,n,e,r){var i=this[t],s=this[o];return null!=n&&0<=n?(i[n]!==e||r)&&(i[n]=e,s[n+":"+t]=-1,s[t]=-1):(i!==e||r)&&(this[t]=e,s[t]=g.isArray(e)?1+e.length:-1),this},a.modified=function(t,n){var e,r=this[o];if(!arguments.length){for(e in r)if(r[e])return!0;return!1}if(g.isArray(t)){for(e=0;e<t.length;++e)if(r[t[e]])return!0;return!1}return null!=n&&0<=n?n+1<r[t]||!!r[n+":"+t]:!!r[t]},a.clear=function(){return this[o]={},this};var f=0,d=new c;function p(t,n,e,r){this.id=++f,this.value=t,this.stamp=-1,this.rank=-1,this.qrank=-1,this.flags=0,n&&(this._update=n),e&&this.parameters(e,r)}var v=p.prototype;function y(e){return function(t){var n=this.flags;return 0===arguments.length?!!(n&e):(this.flags=t?n|e:n&~e,this)}}v.targets=function(){return this._targets||(this._targets=l(g.id))},v.set=function(t){return this.value!==t?(this.value=t,1):0},v.skip=y(1),v.modified=y(2),v.parameters=function(t,r){r=!1!==r;var n,e,i,s,u=this,o=u._argval=u._argval||new c,a=u._argops=u._argops||[],l=[];function h(t,n,e){e instanceof p?(e!==u&&(r&&e.targets().add(u),l.push(e)),a.push({op:e,name:t,index:n})):o.set(t,n,e)}for(n in t)if(e=t[n],"pulse"===n)g.array(e).forEach(function(t){t instanceof p?t!==u&&(t.targets().add(u),l.push(t)):g.error("Pulse parameters must be operator instances.")}),u.source=e;else if(g.isArray(e))for(o.set(n,-1,Array(i=e.length)),s=0;s<i;++s)h(n,s,e[s]);else h(n,-1,e);return this.marshall().clear(),l},v.marshall=function(t){var n,e,r,i,s,u=this._argval||d,o=this._argops;if(o&&(r=o.length))for(e=0;e<r;++e)s=(i=(n=o[e]).op).modified()&&i.stamp===t,u.set(n.name,n.index,i.value,s);return u},v.evaluate=function(t){if(this._update){var n=this.marshall(t.stamp),e=this._update(n,t);if(n.clear(),e!==this.value)this.value=e;else if(!this.modified())return t.StopPropagation}},v.run=function(t){return t.stamp<=this.stamp?t.StopPropagation:(this.skip()?(this.skip(!1),n=0):n=this.evaluate(t),this.stamp=t.stamp,(this.pulse=n)||t);var n};var k=0;function F(t,n,e){this.id=++k,this.value=null,e&&(this.receive=e),t&&(this._filter=t),n&&(this._apply=n)}function w(t,n,e){return new F(t,n,e)}var A=F.prototype;A._filter=g.truthy,A._apply=g.identity,A.targets=function(){return this._targets||(this._targets=l(g.id))},A.consume=function(t){return arguments.length?(this._consume=!!t,this):!!this._consume},A.receive=function(t){if(this._filter(t)){for(var n=this.value=this._apply(t),e=this._targets,r=e?e.length:0,i=0;i<r;++i)e[i].receive(n);this._consume&&(t.preventDefault(),t.stopPropagation())}},A.filter=function(t){var n=w(t);return this.targets().add(n),n},A.apply=function(t){var n=w(null,t);return this.targets().add(n),n},A.merge=function(){var t=w();this.targets().add(t);for(var n=0,e=arguments.length;n<e;++n)arguments[n].targets().add(t);return t},A.throttle=function(n){var e=-1;return this.filter(function(){var t=Date.now();return n<t-e?(e=t,1):0})},A.debounce=function(t){var e=w();return this.targets().add(w(null,null,g.debounce(t,function(t){var n=t.dataflow;e.receive(t),n&&n.run&&n.run()}))),e},A.between=function(t,n){var e=!1;return t.targets().add(w(null,null,function(){e=!0})),n.targets().add(w(null,null,function(){e=!1})),this.filter(function(){return e})};var D={skip:!0};function O(r,t,i,n,e,s){var u,o,a=g.extend({},s,D);g.isFunction(i)||(i=g.constant(i)),void 0===n?u=function(t){r.touch(i(t))}:g.isFunction(n)?(o=new p(null,n,e,!1),u=function(t){var n,e=i(t);o.evaluate(t),h(n=o.value)?r.pulse(e,n,s):r.update(e,n,a)}):u=function(t){r.update(i(t),n,a)},t.apply(u)}function P(t,n,r,e,i,s){var u,o;void 0===e?o=r:(u=g.isFunction(e)?e:g.constant(e),(o=new p(null,e=r?function(t,n){var e=u(t,n);return r.skip()||(r.skip(e!==this.value).value=e),e}:u,i,!1)).modified(s&&s.force),o.rank=0,r&&(o.skip(!0),o.value=r.value,o.targets().add(r))),n.targets().add(o)}var E={};function q(t,n,e){this.dataflow=t,this.stamp=null==n?-1:n,this.add=[],this.rem=[],this.mod=[],this.fields=null,this.encode=e||null}var b=q.prototype;function M(e,r){return e?function(t,n){return e(t,n)&&r(t,n)}:r}function S(t,n){var e=[];return g.visitArray(t,n,function(t){e.push(t)}),e}function L(t,n){var e={};return t.visit(n,function(t){e[m(t)]=1}),function(t){return e[m(t)]?null:t}}function R(t,n,e,r){var i,s,u,o,a,l=this,h=0;for(this.dataflow=t,this.stamp=n,this.fields=null,this.encode=r||null,u=0,o=(this.pulses=e).length;u<o;++u)if((i=e[u]).stamp===n){if(i.fields)for(a in s=l.fields||(l.fields={}),i.fields)s[a]=1;i.changed(l.ADD)&&(h|=l.ADD),i.changed(l.REM)&&(h|=l.REM),i.changed(l.MOD)&&(h|=l.MOD)}this.changes=h}b.StopPropagation=E,b.ADD=1,b.REM=2,b.MOD=4,b.ADD_REM=3,b.ADD_MOD=5,b.ALL=7,b.REFLOW=8,b.SOURCE=16,b.NO_SOURCE=32,b.NO_FIELDS=64,b.fork=function(t){return new q(this.dataflow).init(this,t)},b.clone=function(){var t=this.fork(7);return t.add=t.add.slice(),t.rem=t.rem.slice(),t.mod=t.mod.slice(),t.source&&(t.source=t.source.slice()),t.materialize(23)},b.addAll=function(){var t=this;return this.source&&this.source.length!==this.add.length&&((t=new q(this.dataflow).init(this)).add=t.source),t},b.init=function(t,n){var e=this;return e.stamp=t.stamp,e.encode=t.encode,!t.fields||64&n||(e.fields=t.fields),1&n?(e.addF=t.addF,e.add=t.add):(e.addF=null,e.add=[]),2&n?(e.remF=t.remF,e.rem=t.rem):(e.remF=null,e.rem=[]),4&n?(e.modF=t.modF,e.mod=t.mod):(e.modF=null,e.mod=[]),32&n?(e.srcF=null,e.source=null):(e.srcF=t.srcF,e.source=t.source),e},b.runAfter=function(t){this.dataflow.runAfter(t)},b.changed=function(t){var n=t||7;return 1&n&&this.add.length||2&n&&this.rem.length||4&n&&this.mod.length},b.reflow=function(t){if(t)return this.fork(7).reflow();var n=this.add.length,e=this.source&&this.source.length;return e&&e!==n&&(this.mod=this.source,n&&this.filter(4,L(this,1))),this},b.modifies=function(t){var n=g.array(t),e=this.fields||(this.fields={});return n.forEach(function(t){e[t]=!0}),this},b.modified=function(t){var n=this.fields;return!(!this.mod.length||!n)&&(arguments.length?g.isArray(t)?t.some(function(t){return n[t]}):n[t]:!!n)},b.filter=function(t,n){var e=this;return 1&t&&(e.addF=M(e.addF,n)),2&t&&(e.remF=M(e.remF,n)),4&t&&(e.modF=M(e.modF,n)),16&t&&(e.srcF=M(e.srcF,n)),e},b.materialize=function(t){var n=this;return 1&(t=t||7)&&n.addF&&(n.add=S(n.add,n.addF),n.addF=null),2&t&&n.remF&&(n.rem=S(n.rem,n.remF),n.remF=null),4&t&&n.modF&&(n.mod=S(n.mod,n.modF),n.modF=null),16&t&&n.srcF&&(n.source=n.source.filter(n.srcF),n.srcF=null),n},b.visit=function(t,n){var e,r,i=this,s=n;return 16&t?g.visitArray(i.source,i.srcF,s):(1&t&&g.visitArray(i.add,i.addF,s),2&t&&g.visitArray(i.rem,i.remF,s),4&t&&g.visitArray(i.mod,i.modF,s),8&t&&(e=i.source)&&((r=i.add.length+i.mod.length)===e.length||(r?g.visitArray(e,L(i,5),s):g.visitArray(e,i.srcF,s)))),i};var x=g.inherits(R,q);function T(n,t){try{t(n)}catch(t){n.error(t)}}x.fork=function(t){var n=new q(this.dataflow).init(this,t&this.NO_FIELDS);return void 0!==t&&(t&n.ADD&&this.visit(n.ADD,function(t){return n.add.push(t)}),t&n.REM&&this.visit(n.REM,function(t){return n.rem.push(t)}),t&n.MOD&&this.visit(n.MOD,function(t){return n.mod.push(t)})),n},x.changed=function(t){return this.changes&t},x.modified=function(t){var n=this.fields;return n&&this.changes&this.MOD?g.isArray(t)?t.some(function(t){return n[t]}):n[t]:0},x.filter=function(){g.error("MultiPulse does not support filtering.")},x.materialize=function(){g.error("MultiPulse does not support materialization.")};var z={skip:!(x.visit=function(t,n){var e=this.pulses,r=e.length,i=0;if(t&this.SOURCE)for(;i<r;++i)e[i].visit(t,n);else for(;i<r;++i)e[i].stamp===this.stamp&&e[i].visit(t,n);return this}),force:!1};function C(t){this.cmp=t,this.nodes=[]}var I=C.prototype;function U(t,n,e,r){var i,s,u;for(i=t[e];n<e&&r(i,s=t[u=e-1>>1])<0;)t[e]=s,e=u;return t[e]=i}function j(t,n,e){for(var r,i=n,s=t.length,u=t[n],o=2*n+1;o<s;)(r=o+1)<s&&0<=e(t[o],t[r])&&(o=r),t[n]=t[o],o=2*(n=o)+1;return t[n]=u,U(t,i,n,e)}function N(){this._log=g.logger(),this.logLevel(g.Error),this._clock=0,this._rank=0;try{this._loader=r.loader()}catch(t){}this._touched=l(g.id),this._pulses={},this._pulse=null,this._heap=new C(function(t,n){return t.qrank-n.qrank}),this._postrun=[]}I.size=function(){return this.nodes.length},I.clear=function(){return this.nodes=[],this},I.peek=function(){return this.nodes[0]},I.push=function(t){var n=this.nodes;return n.push(t),U(n,0,n.length-1,this.cmp)},I.pop=function(){var t,n=this.nodes,e=n.pop();return n.length?(t=n[0],n[0]=e,j(n,0,this.cmp)):t=e,t},I.replace=function(t){var n=this.nodes,e=n[0];return n[0]=t,j(n,0,this.cmp),e},I.pushpop=function(t){var n=this.nodes,e=n[0];return n.length&&this.cmp(e,t)<0&&(n[0]=t,t=e,j(n,0,this.cmp)),t};var G=N.prototype;function W(t){return function(){return this._log[t].apply(this,arguments)}}function B(t,n){p.call(this,t,null,n)}G.stamp=function(){return this._clock},G.loader=function(t){return arguments.length?(this._loader=t,this):this._loader},G.cleanThreshold=1e4,G.add=function(t,n,e,r){var i,s=1;return t instanceof p?i=t:t&&t.prototype instanceof p?i=new t:g.isFunction(t)?i=new p(null,t):(s=0,i=new p(t,n)),this.rank(i),s&&(r=e,e=n),e&&this.connect(i,i.parameters(e,r)),this.touch(i),i},G.connect=function(t,n){var e,r,i=t.rank;for(e=0,r=n.length;e<r;++e)if(i<n[e].rank)return void this.rerank(t)},G.rank=function(t){t.rank=++this._rank},G.rerank=function(t){for(var n,e,r,i=[t];i.length;)if(this.rank(n=i.pop()),e=n._targets)for(r=e.length;0<=--r;)i.push(n=e[r]),n===t&&g.error("Cycle detected in dataflow graph.")},G.pulse=function(t,n,e){this.touch(t,e||z);var r=new q(this,this._clock+(this._pulse?0:1)),i=t.pulse&&t.pulse.source||[];return r.target=t,this._pulses[t.id]=n.pulse(r,i),this},G.touch=function(t,n){var e=n||z;return this._pulse?this._enqueue(t):this._touched.add(t),e.skip&&t.skip(!0),this},G.update=function(t,n,e){var r=e||z;return(t.set(n)||r.force)&&this.touch(t,r),this},G.changeset=u,G.ingest=function(t,n,e){return this.pulse(t,this.changeset().insert(r.read(n,e)))},G.request=function(n,e,r){var t,i,s,u,o=this,a=o._pending||(t=o,(u=new Promise(function(t,n){i=t,s=n})).requests=0,u.done=function(){0==--u.requests&&t.runAfter(function(){t._pending=null;try{t.run(),i(t)}catch(t){s(t)}})},t._pending=u);a.requests+=1,o.loader().load(e,{context:"dataflow"}).then(function(t){o.ingest(n,t,r)},function(t){o.error("Loading failed",e,t)}).catch(function(t){o.error("Data ingestion failed",e,t)}).then(a.done,a.done)},G.events=function(t,n,e,r){for(var i,s=this,u=w(e,r),o=function(t){t.dataflow=s;try{u.receive(t)}catch(t){s.error(t)}finally{s.run()}},a=0,l=(i="string"==typeof t&&"undefined"!=typeof document?document.querySelectorAll(t):g.array(t)).length;a<l;++a)i[a].addEventListener(n,o);return u},G.on=function(t,n,e,r,i){return(t instanceof p?P:O)(this,t,n,e,r,i),this},G.run=function(t){var n,e,r,i,s=this,u=0,o=s.logLevel();if(s._pending)return s.info("Awaiting requests, delaying dataflow run."),0;if(s._pulse)return s.error("Dataflow invoked recursively. Use the runAfter method to queue invocation."),0;if(!s._touched.length)return s.info("Dataflow invoked, but nothing to do."),0;s._pulse=new q(s,++s._clock,t),o>=g.Info&&(r=Date.now(),s.debug("-- START PROPAGATION ("+s._clock+") -----")),s._touched.forEach(function(t){s._enqueue(t,!0)}),s._touched=l(g.id);try{for(;0<s._heap.size();)(n=s._heap.pop()).rank===n.qrank?(e=n.run(s._getPulse(n,t)),o>=g.Debug&&s.debug(n.id,e===E?"STOP":e,n),e!==E&&(s._pulse=e,n._targets&&n._targets.forEach(function(t){s._enqueue(t)})),++u):s._enqueue(n,!0)}catch(t){i=t}if(s._pulses={},s._pulse=null,o>=g.Info&&(r=Date.now()-r,s.info("> Pulse "+s._clock+": "+u+" operators; "+r+"ms")),i&&(s._postrun=[],s.error(i)),s._onrun)try{s._onrun(s,u,i)}catch(t){s.error(t)}if(s._postrun.length){var a=s._postrun;s._postrun=[],a.sort(function(t,n){return n.priority-t.priority}).forEach(function(t){T(s,t.callback)})}return u},G.runAsync=function(){return this._pending||Promise.resolve(this.run())},G.runAfter=function(t,n,e){this._pulse||n?this._postrun.push({priority:e||0,callback:t}):T(this,t)},G._enqueue=function(t,n){var e=!this._pulses[t.id];e&&(this._pulses[t.id]=this._pulse),(e||n)&&(t.qrank=t.rank,this._heap.push(t))},G._getPulse=function(t,n){var e,r=t.source,i=this._clock;return r&&g.isArray(r)?new R(this,i,e=r.map(function(t){return t.pulse}),n):(e=this._pulses[t.id],r&&((r=r.pulse)&&r!==E?r.stamp===i&&e.target!==t?e=r:e.source=r.source:e.source=[]),e)},G.error=W("error"),G.warn=W("warn"),G.info=W("info"),G.debug=W("debug"),G.logLevel=W("level");var H=g.inherits(B,p);H.run=function(t){return t.stamp<=this.stamp?t.StopPropagation:(this.skip()?this.skip(!1):n=this.evaluate(t),(n=n||t)!==t.StopPropagation&&(this.pulse=n),this.stamp=t.stamp,n);var n},H.evaluate=function(t){var n=this.marshall(t.stamp),e=this.transform(n,t);return n.clear(),e},H.transform=function(){};var J={};function K(t){return t=t&&t.toLowerCase(),J.hasOwnProperty(t)?J[t]:null}t.UniqueList=l,t.changeset=u,t.isChangeSet=h,t.Dataflow=N,t.EventStream=F,t.Parameters=c,t.Pulse=q,t.MultiPulse=R,t.Operator=p,t.Transform=B,t.derive=function(t){return n(t,_({}))},t.rederive=n,t.ingest=_,t.isTuple=function(t){return!(!t||!m(t))},t.replace=function(t,n){return s(n,m(t))},t.tupleid=m,t.definition=function(t){var n=K(t);return n&&n.Definition||null},t.transform=K,t.transforms=J,Object.defineProperty(t,"__esModule",{value:!0})});